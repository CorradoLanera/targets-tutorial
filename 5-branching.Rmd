---
title: "Patterns and branching"
output: html_document
---

# About

For pipelines with hundreds or thousands of targets, it is impractical to write out every single target by hand in `_targets.R`. That's why the `targets` package supports branching, which is a way to write shorthand for large collections of similar targets.

# Setup

Start with a fresh data store.

```{r}
library(targets)
tar_destroy()
```

Copy the starting `_targets.R` file into the working directory.

```{r}
tmp <- file.copy("5-branching/initial_targets.R", "_targets.R", overwrite = TRUE)
```

Also load the quiz questions. Try not to peek in advance.

```{r}
source("R/quiz.R")
source("5-branching/answers.R")
```

# Branching with map()

Our `_targets.R` file has a new version of our pipeline with branching. Open for editing.

```{r}
library(usethis)
edit_file("_targets.R", open = TRUE)
```

What is different about this new pipeline?

A. It has a new `activations` target that returns the names of all the activation functions we want to try.
B. All our previous `run_*` targets are combined into a new target called `run`.
C. All of A, B, and D.
D. The `run` target sets `pattern = map(activations)` to declare a separate model run for every element of the return value of the `activations` target.

```{r}
answer5_different("E")
```

Run the pipeline. Each model run is a dynamically created branch of the `run` target.

```{r}
tar_make()
```

Depending on what you change, some branches may run while others are skipped. As an example, add the softmax activation function in `_targets.R`. Sketch:

```{r, eval = FALSE}
tar_target(activations, c("relu", "sigmoid", "softmax"))
```

Now, run the pipeline.

```{r}
tar_make()
```

Which targets reran? Why?

A. Just the new run with the softmax activation function. The rest of the targets were already up to date, so `tar_make()` skipped them.
B. Just the new run with the sigmoid activation function. The rest of the targets were already up to date, so `tar_make()` skipped them.
C. The new run with the softmax activation function, the `best_run` target if the model accuracy might changed, and  `best_model` if `best_run` changed. `tar_make()` skipped the other model runs because they were already up to date.
D. All the model runs and everything downstream because the `activations` target changed.

```{r}
answer5_map_runs("E")
```



<<<<dynamically branch over branches>>>>

# Branching with cross()

# Vector iteration

# List iteration

# Group iteration

# Branching over files
