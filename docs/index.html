<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Reproducible computation at scale in R</title>
    <meta charset="utf-8" />
    <meta name="author" content="Will Landau" />
    <script src="index_files/header-attrs/header-attrs.js"></script>
    <link href="index_files/remark-css/default.css" rel="stylesheet" />
    <link href="index_files/remark-css/default-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Reproducible computation at scale in R
### Will Landau

---


&lt;style&gt;
.inverse {
background-color: transparent;
text-shadow: 0 0 0px transparent;
}
.title-slide {
vertical-align: bottom !important; 
text-align: center !important;
}
.title-slide h1 {
position: absolute;
top: 0;
left: 0;
right: 0;
width: 100%;
line-height: 4em;
color: #666666;
}
.title-slide h3 {
line-height: 6em;
color: #666666;
}
.title-slide {
background-color: white;
background-image: url('images/logo.png');
background-repeat: no-repeat;
background-size: 25%;
}
.remark-slide-content:after {
content: "Copyright Eli Lilly and Company";
position: absolute;
bottom: -5px;
left: 10px;
height: 40px;
width: 100%;
font-family: Helvetica, Arial, sans-serif;
font-size: 0.7em;
color: gray;
background-repeat: no-repeat;
background-size: contain;
}
&lt;/style&gt;





## Large statistical computation

* [Bayesian data analysis](https://mc-stan.org/)
* [Bayesian network meta-analysis](https://bookdown.org/MathiasHarrer/Doing_Meta_Analysis_in_R/bayesian-network-meta-analysis.html)
* [Graph-based multiple comparison procedures](https://github.com/kornl/gMCP)
* [Subgroup identification](https://cran.r-project.org/web/packages/TSDT/index.html)
* [Predictive modeling](http://appliedpredictivemodeling.com/computing)
* [Deep neural networks](https://keras.rstudio.com/)
* [PK/PD modeling](https://github.com/nlmixrdevelopment/nlmixr)
* Clinical trial simulation
* Target identification

---

## Common features

1. Heavy use of the [R language](https://www.r-project.org/).
2. Long runtimes.
3. Multiple sub-tasks.
4. Frequent changes to code and data.

&lt;img src = "./images/sisyphus.svg" align="left" style="border: none; box-shadow: none; height: 325px; text-align: center;"&gt;
&lt;br&gt;
&lt;a href="https://openclipart.org/detail/275842/sisyphus-overcoming-silhouette"&gt;https://openclipart.org/detail/275842/sisyphus-overcoming-silhouette&lt;/a&gt;

---

## Interconnected tasks
&lt;center&gt;
&lt;img src = "./images/workflow.png" align="middle" style="border: none; box-shadow: none; text-align: center;"&gt;
&lt;/center&gt;

---

## Changes

&lt;center&gt;
&lt;img src = "./images/change.png" align="middle" style="border: none; box-shadow: none; text-align: center;"&gt;
&lt;/center&gt;

---

## Consequences

&lt;center&gt;
&lt;img src = "./images/downstream.png" align="middle" style="border: none; box-shadow: none; text-align: center;"&gt;
&lt;/center&gt;

---

## Pipeline tools and workflow managers

&lt;center&gt;
&lt;img src = "./images/infographic.svg" align="middle" style="border: none; box-shadow: none; text-align: center;"&gt;
&lt;/center&gt;

- Tons exist already: [github.com/pditommaso/awesome-pipeline](https://github.com/pditommaso/awesome-pipeline).
- Most are language-agnostic or designed for Python or the shell.

---

## What distinguishes `targets`?

&lt;center&gt;
&lt;img src = "./images/R.png" align="middle" style="border: none; box-shadow: none; text-align: center; height: 80px"&gt;
&lt;/center&gt;

* Fundamentally designed for R.
* Supports a clean, modular, function-oriented programming style.
* Abstracts files as R objects and automatically manages data.
* Surpasses the permanent limitations of its predecessor, [`drake`](https://github.com/ropensci/drake): &lt;https://wlandau.github.io/targets/articles/need.html&gt;

---

## What about `drake`?

* `drake` is still an excellent choice for pipeline management, but it has permanent user-side limitations.
* `targets` was created to overcome these limitations and create a smoother user experience.
    1. Stronger guardrails by design.
    1. A friendlier, lighter, more transparent data management system.
    1. Show which *functions* are up to date.
    1. More flexible dynamic branching, including compatibility with `dplyr::group_by()`.
    1. Improved parallel efficiency.
    1. Designed for custom user-side [metaprogramming](https://wlandau.github.io/targets-manual/branching.html#metaprogramming) and target archetypes: &lt;https://wlandau.github.io/tarchetypes/&gt;.

---

## Example targets workflow

- Find the model that best predicts which customers will cancel their telecom subscriptions.
- [IBM Watson Telco Customer Churn dataset](https://www.ibm.com/communities/analytics/watson-analytics-blog/predictive-insights-in-the-telco-customer-churn-data-set/).
- Workflow principles generalize to the other fields, such as the life sciences.

---

background-image: ./images/not.png

## &lt;img src="./images/no.png" width="40" height="40"&gt; Move away from numbered imperative scripts.


```r
run_everything.R
R/
├── 01-data.R
├── 02-munge.R
├── 03-model.R
├── 04-results.R
└── 05-plot.R
data/
└── customer_churn.csv
```

---

## &lt;img src="./images/yes.png" width="60" height="40"&gt; Embrace **functions**.

&gt;    - Everything that exists is an object.
&gt;    - Everything that happens is a function call.
&gt;
&gt; John Chambers


```r
add_things &lt;- function(argument1, argument2) {
  argument1 + argument2
}

add_things(1, 2)
#&gt; [1] 3

add_things(c(3, 4), c(5, 6))
#&gt; [1]  8 10
```

---

## Functions for customer churn


```r
split_data &lt;- function(churn_file) {
  read_csv(churn_file, col_types = cols()) %&gt;%
    initial_split(prop = 0.3)
}

prepare_recipe &lt;- function(churn_data) {
  churn_data %&gt;%
    training() %&gt;%
    recipe(Churn ~ .) %&gt;%
    step_rm(customerID) %&gt;%
    step_naomit(all_outcomes(), all_predictors()) %&gt;%
    step_discretize(tenure, options = list(cuts = 6)) %&gt;%
    step_log(TotalCharges) %&gt;%
    step_mutate(Churn = ifelse(Churn == "Yes", 1, 0)) %&gt;%
    step_dummy(all_nominal(), -all_outcomes()) %&gt;%
    step_center(all_predictors(), -all_outcomes()) %&gt;%
    step_scale(all_predictors(), -all_outcomes()) %&gt;%
    prep()
}
```

---

## Functions for customer churn


```r
define_model &lt;- function(churn_recipe, units1, units2, act1, act2, act3) {
  # ...
}

train_model &lt;- function(churn_recipe, units1, units2, act1, act2, act3) {
  # ...
}

test_accuracy &lt;- function(churn_data, churn_recipe, churn_model) {
  # ...
}

test_model &lt;- function(churn_data, churn_recipe, units1, units2, act1, act2, act3) {
  # ...
}

retrain_run &lt;- function(churn_run, churn_recipe) {
  # ...
}
```

---

## Typical project structure

* There are many variations on this theme.


```r
_targets/  # Output data objects are automatically written here.
_targets.R # Required top-level configuration file.
R/
*└── functions.R
data/
└── customer_churn.csv
```

---

## Build up your workflow as a pipeline of targets.


```r
# _targets.R
library(targets)
source("R/functions.R")
tar_option_set(packages = c("keras", "tidyverse", "rsample", "recipes", "yardstick"))
tar_pipeline(
  tar_target(churn_file, "data/customer_churn.csv", format = "file"),
  tar_target(churn_data, split_data(churn_file)),
  tar_target(churn_recipe, prepare_recipe(churn_data))
)
```



---

## The pipeline is a collection of skippable *targets*.


```r
tar_manifest(fields = c("name", "command"))
#&gt; # A tibble: 3 x 2
#&gt;   name         command                      
#&gt;   &lt;chr&gt;        &lt;chr&gt;                        
#&gt; 1 churn_recipe "prepare_recipe(churn_data)" 
#&gt; 2 churn_data   "split_data(churn_file)"     
#&gt; 3 churn_file   "\"data/customer_churn.csv\""
```

---

## targets understands code and data dependencies.


```r
tar_visnetwork()
```

&lt;center&gt;
&lt;img src="images/graph1.png", height = "400px" align="middle" style="border: none; box-shadow: none; text-align: center;"&gt;
&lt;/center&gt;

---

## Build your first targets.


```r
tar_make()
```


```
#&gt; ● run target churn_file
#&gt; ● run target churn_data
#&gt; ● run target churn_recipe
```

---

## Check the targets for problems

- `tar_load()` and `tar_read()` get targets from the `_targets/` data store.


```r
ncol(training(tar_read(churn_data)))
#&gt; [1] 21

tar_load(churn_recipe)
ncol(juice(churn_recipe))
#&gt; [1] 36
```

---

## Build up the pipeline *gradually*.

.large[
1. Add a couple targets.
2. Run the pipeline with `tar_make()`.
3. Inspect the new targets with `tar_load()` and `tar_read()`.
4. Repeat often. Not very time-consuming because `tar_make()` skips up-to-date targets.
]

---

## Add some models.


```r
# _targets.R
library(targets)
source("R/functions.R")
tar_option_set(packages = c("keras", "tidyverse", "rsample", "recipes", "yardstick"))
tar_pipeline(
  tar_target(churn_file, "data/customer_churn.csv", format = "file"),
  tar_target(churn_data, split_data(churn_file)),
  tar_target(churn_recipe, prepare_recipe(churn_data)),
* tar_target(run_relu, test_model(act1 = "relu", churn_data, churn_recipe)),
* tar_target(run_sigmoid, test_model(act1 = "sigmoid", churn_data, churn_recipe))
)
```



---

## Previous work is still up to date.


```r
tar_outdated()
```


```
#&gt; [1] "run_relu"    "run_sigmoid"
```

---

## Previous work is still up to date.


```r
tar_visnetwork()
```
&lt;center&gt;
&lt;img src="images/graph2.png", height = "400px" align="middle" style="border: none; box-shadow: none; text-align: center;"&gt;
&lt;/center&gt;

---

## Up-to-date targets are skipped.


```r
tar_make()
```


```
#&gt; ✓ skip target churn_file
#&gt; ✓ skip target churn_data
#&gt; ✓ skip target churn_recipe
#&gt; ● run target run_relu
#&gt; ● run target run_sigmoid
```

---

## Inspect the newest targets.


```r
tar_read(run_relu)
#&gt; # A tibble: 1 x 6
#&gt;   accuracy units1 units2 act1  act2  act3   
#&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;  
#&gt; 1    0.795     16     16 relu  relu  sigmoid

tar_read(run_sigmoid)
#&gt; # A tibble: 1 x 6
#&gt;   accuracy units1 units2 act1    act2  act3   
#&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;  
#&gt; 1    0.800     16     16 sigmoid relu  sigmoid
```

---

## Find the best model


```r
# _targets.R
library(targets)
source("R/functions.R")
tar_option_set(packages = c("keras", "tidyverse", "rsample", "recipes", "yardstick"))
tar_pipeline(
  ...,
  tar_target(run_relu, test_model(act1 = "relu", churn_data, churn_recipe)),
  tar_target(run_sigmoid, test_model(act1 = "sigmoid", churn_data, churn_recipe)),
* tar_target(
*   best_run,
*   bind_rows(run_relu, run_sigmoid) %&gt;%
*     top_n(1, accuracy) %&gt;%
*     head(1)
* ),
* tar_target(
*   best_model,
*   retrain_run(best_run, churn_recipe),
*   format = "keras"
* )
)
```



---

## Find the best model


```r
tar_make()
```


```
#&gt; ✓ skip target churn_file
#&gt; ✓ skip target churn_data
#&gt; ✓ skip target churn_recipe
#&gt; ✓ skip target run_relu
#&gt; ✓ skip target run_sigmoid
#&gt; ● run target best_run
#&gt; ● run target best_model
```

---

## Find the best model


```r
tar_read(best_model)
#&gt; Model
#&gt; Model: "sequential_2"
#&gt; ________________________________________________________________________________
#&gt; Layer (type)                        Output Shape                    Param #     
#&gt; ================================================================================
#&gt; dense_6 (Dense)                     (None, 16)                      576         
#&gt; ________________________________________________________________________________
#&gt; dropout_4 (Dropout)                 (None, 16)                      0           
#&gt; ________________________________________________________________________________
#&gt; dense_7 (Dense)                     (None, 16)                      272         
#&gt; ________________________________________________________________________________
#&gt; dropout_5 (Dropout)                 (None, 16)                      0           
#&gt; ________________________________________________________________________________
#&gt; dense_8 (Dense)                     (None, 1)                       17          
#&gt; ================================================================================
#&gt; Total params: 865
#&gt; Trainable params: 865
#&gt; Non-trainable params: 0
#&gt; ________________________________________________________________________________
```

---

## Try another model.


```r
# _targets.R
library(targets)
source("R/functions.R")
tar_option_set(packages = c("keras", "tidyverse", "rsample", "recipes", "yardstick"))
tar_pipeline(
  ...,
  tar_target(run_relu, test_model(act1 = "relu", churn_data, churn_recipe)),
  tar_target(run_sigmoid, test_model(act1 = "sigmoid", churn_data, churn_recipe)),
* tar_target(run_softmax, test_model(act1 = "softmax", churn_data, churn_recipe)),
  tar_target(
    best_run,
*   bind_rows(run_relu, run_sigmoid, run_softmax) %&gt;%
      top_n(1, accuracy) %&gt;%
      head(1)
  ),
  ...
)
```



---

## What gets done stays done.


```r
tar_outdated()
```


```
#&gt; [1] "run_softmax" "best_run"    "best_model"
```

---

## What gets done stays done.


```r
tar_visnetwork()
```

&lt;center&gt;
&lt;img src="images/graph3.png", height = "400px" align="middle" style="border: none; box-shadow: none; text-align: center;"&gt;
&lt;/center&gt;

---

## New best model?

- Only if the new run beats the old runs, which would invalidate target `best_run`.
- Otherwise, `drake` does not bother to retrain the best model.


```r
tar_make()
#&gt; ✓ skip target churn_file
#&gt; ✓ skip target churn_data
#&gt; ✓ skip target churn_recipe
#&gt; ✓ skip target run_relu
#&gt; ✓ skip target run_sigmoid
#&gt; ● run target run_softmax
#&gt; ● run target best_run
#&gt; ✓ skip target best_model
```



---

## What if we need to change a function?


```r
define_model &lt;- function(churn_recipe, units1, units2, act1, act2, act3) {
  input_shape &lt;- ncol(
    juice(churn_recipe, all_predictors(), composition = "matrix")
  )
  keras_model_sequential() %&gt;%
    layer_dense(
      units = units1,
      kernel_initializer = "uniform",
      activation = act1,
      input_shape = input_shape
    ) %&gt;%
*   layer_dropout(rate = 0.2) %&gt;% # previously 0.1
    layer_dense(
      units = units2,
      kernel_initializer = "uniform",
      activation = act2
    ) %&gt;%
    layer_dropout(rate = 0.1) %&gt;%
    ...
```

---

## Show invalidated functions and targets.


```r
tar_visnetwork()
```

&lt;center&gt;
&lt;img src="images/graph4.png", height = "400px" align="middle" style="border: none; box-shadow: none; text-align: center;"&gt;
&lt;/center&gt;

---

## Rerun invalidated targets.


```r
tar_make()
#&gt; ✓ skip target churn_file
#&gt; ✓ skip target churn_data
#&gt; ✓ skip target churn_recipe
#&gt; ● run target run_relu
#&gt; ● run target run_sigmoid
#&gt; ● run target run_softmax
#&gt; ● run target best_run
#&gt; ● run target best_model
```

---

## Similar story if the data file changes.



```r
tar_make()
#&gt; ● run target churn_file
#&gt; ● run target churn_data
#&gt; ● run target churn_recipe
#&gt; ● run target run_relu
#&gt; ● run target run_sigmoid
#&gt; ● run target run_softmax
#&gt; ● run target best_run
#&gt; ● run target best_model
```

---

## Evidence of reproducibility


```r
tar_make(plan)
#&gt; ✓ skip target churn_file
#&gt; ✓ skip target churn_data
#&gt; ✓ skip target churn_recipe
#&gt; ✓ skip target run_relu
#&gt; ✓ skip target run_sigmoid
#&gt; ✓ skip target run_softmax
#&gt; ✓ skip target best_run
#&gt; ✓ skip target best_model
#&gt; ✓ Already up to date.
```

---

## Evidence of reproducibility


```r
tar_outdated()
#&gt; character(0)

tar_visnetwork()
```

&lt;center&gt;
&lt;img src="images/graph5.png", height = "350px" align="middle" style="border: none; box-shadow: none; text-align: center;"&gt;
&lt;/center&gt;

---

## Resources

* Get [`targets`](https://github.com/wlandau/targets):


```r
install.packages("remotes")
remotes::install_github("wlandau/targets")
```

* Code: &lt;https://github.com/wlandau/targets-keras&gt;
* RStudio Cloud workspace: &lt;https://rstudio.cloud/project/1430828/&gt;
* These slides: &lt;https://wlandau.github.io/targets-tutorial&gt;
* Tutorial materials: &lt;https://github.com/wlandau/targets-tutorial&gt;
* Development repository: &lt;https://github.com/wlandau/targets&gt;
* Full user manual: &lt;https://wlandau.github.io/targets-manual/&gt;
* Reference website: &lt;https://wlandau.github.io/targets/&gt;

---

## Thanks

&lt;br&gt;
&lt;br&gt;
&lt;table style = "border: none"&gt;
&lt;tr&gt;
&lt;td style = "padding-right: 125px"&gt;
&lt;ul style&gt;
&lt;img src = "./images/edgar.jpg" style="border: none; box-shadow: none; height: 150px"&gt;
&lt;li&gt;&lt;a href = "https://github.com/edgararuiz"&gt;Edgar Ruiz&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/sol-eng/tensorflow-w-r/blob/master/workflow/tensorflow-drake.Rmd"&gt;example code&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;td&gt;
&lt;ul&gt;
&lt;img src = "./images/matt.jpg" style="border: none; box-shadow: none; height: 150px"&gt;
&lt;li&gt;&lt;a href = "https://github.com/mdancho84"&gt;Matt Dancho&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://blogs.rstudio.com/tensorflow/posts/2018-01-11-keras-customer-churn/"&gt;blog post&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;

---

## The tutorial

1. Sign up for a free account at &lt;https://rstudio.cloud&gt;.
2. Log into &lt;https://rstudio.cloud/project/1500267&gt;.
3. Work through the R notebooks in order.

Topic | Notebook
---|---
Custom functions | [`1-functions.Rmd`](https://github.com/wlandau/targets-tutorial/blob/master/1-functions.Rmd)
`targets` pipelines | [`2-pipelines.Rmd`](https://github.com/wlandau/targets-tutorial/blob/master/2-pipelines.Rmd)
Changing workflows | [`3-changes.Rmd`](https://github.com/wlandau/targets-tutorial/blob/master/3-changes.Rmd)
External files | [`4-files.Rmd`](https://github.com/wlandau/targets-tutorial/blob/master/4-files.Rmd)
Patterns and branching | [`5-branching.Rmd`](https://github.com/wlandau/targets-tutorial/blob/master/5-branching.Rmd)
Metaprogramming | [`6-metaprogramming.Rmd`](https://github.com/wlandau/targets-tutorial/blob/master/6-metaprogramming.Rmd)


    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightLines": true
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
